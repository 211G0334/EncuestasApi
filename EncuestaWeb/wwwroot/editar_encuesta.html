<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Editar Encuesta</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <h2>Editar Encuesta</h2>

    <label for="encuestaSelect">Selecciona una encuesta:</label>
    <select id="encuestaSelect">
        <option disabled selected>-- Selecciona --</option>
    </select>

    <label for="tituloEncuesta">Nuevo título:</label>
    <input type="text" id="tituloEncuesta" placeholder="Nuevo título" />

    <div id="preguntas"></div>
    <div class="question-count" id="contadorPreguntas">Preguntas: 0 / 10</div>
    <button onclick="agregarPregunta()">Agregar Pregunta</button>
    <button id="btnGuardarCambios"> Guardar Cambios</button>

    <script>
        const BASE_URL = `${location.protocol}//${location.hostname}:44341`;
        const token = sessionStorage.getItem("token");

        const select = document.getElementById("encuestaSelect");
        const contenedor = document.getElementById("preguntas");
        const tituloInput = document.getElementById("tituloEncuesta");
        const contador = document.getElementById("contadorPreguntas");
        const guardarBtn = document.getElementById("btnGuardarCambios");

        let encuestaId = null;

        function actualizarContador() {
            const total = contenedor.querySelectorAll(".input-group").length;
            contador.textContent = `Preguntas: ${total} / 10`;
            contenedor.querySelectorAll(".input-group span").forEach((span, i) => {
                span.textContent = i + 1;
            });
        }

        function crearPregunta(preguntaId = 0, texto = "") {
            const div = document.createElement("div");
            div.className = "input-group";
            div.innerHTML = `
                  <span></span>
                  <input type="text" value="${texto}" data-id="${preguntaId}">
                  <button type="button">🗑️</button>
              `;
            div.querySelector("button").addEventListener("click", () => {
                div.remove();
                actualizarContador();
            });
            contenedor.appendChild(div);
            actualizarContador();
        }

        async function cargarEncuestas() {
            try {
                const res = await fetch(`${BASE_URL}/api/encuestas`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const data = await res.json();

                data.lstEncusta.forEach(e => {
                    const opt = document.createElement("option");
                    opt.value = e.id;
                    opt.textContent = e.titulo;
                    select.appendChild(opt);
                });
            } catch (err) {
                alert("❌ Error al cargar encuestas");
            }
        }

        select.addEventListener("change", async () => {
            contenedor.innerHTML = "";
            encuestaId = select.value;
            try {
                const res = await fetch(`${BASE_URL}/api/encuestas/${encuestaId}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const data = await res.json();
                tituloInput.value = data.titulo;
                data.lstPreguntas.forEach(p => crearPregunta(p.id, p.texto));
            } catch (err) {
                alert("❌ Error al cargar preguntas");
            }
        });

        document.getElementById("btnGuardarCambios").addEventListener("click", async () => {

            const titulo = tituloInput.value.trim();
            if (!titulo) return alert("⚠️ Título obligatorio");


            const inputs = contenedor.querySelectorAll("input");
            if (inputs.length === 0) return alert("⚠️ Agrega al menos una pregunta");


            const preguntas = [...inputs].map(input => ({
                id: parseInt(input.dataset.id || "0"),
                texto: input.value.trim()

            })).filter(p => p.texto.length > 0);

            const dto = {
                id: parseInt(encuestaId),
                titulo: titulo,
                Preguntas: preguntas
            };

            try {
                const res = await fetch(`${BASE_URL}/api/encuestas/editar`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${token}`
                    },
                    body: JSON.stringify(dto)
                });

                const mensaje = await res.text();

                if (!res.ok) throw new Error(mensaje);

                alert("ok" + mensaje);
            } catch (err) {
                alert("❌ " + err.message);
            }

        });

        function agregarPregunta() {
            if (contenedor.children.length >= 10) {
                alert("Solo un maximo de 10 preguntas");
                return;
            }
            crearPregunta();
        }

        cargarEncuestas();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Responder Encuesta</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <style>
        :root {
            --primary-red: #e63946;
            --dark-red: #d90429;
            --primary-green: #2a9d8f;
            --dark-green: #1d7874;
            --tech-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            --light-gray: #f1faee;
            --dark-gray: #1d3557;
            --card-bg: rgba(29, 53, 87, 0.85);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: var(--tech-gradient);
            color: var(--light-gray);
            min-height: 100vh;
            padding: 2rem;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3),
                        0 0 15px rgba(42, 157, 143, 0.2),
                        inset 0 0 10px rgba(230, 57, 70, 0.1);
            border: 1px solid rgba(42, 157, 143, 0.2);
        }
        
        h3 {
            color: var(--light-gray);
            font-size: 1.8rem;
            margin-bottom: 2rem;
            text-align: center;
            position: relative;
            padding-bottom: 10px;
        }
        
        h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: var(--primary-green);
            border-radius: 3px;
        }
        
        .pregunta {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: rgba(241, 250, 238, 0.05);
            border-radius: 10px;
            border-left: 3px solid var(--primary-red);
            transition: all 0.3s ease;
        }
        
        .pregunta:hover {
            background: rgba(241, 250, 238, 0.08);
            border-left: 3px solid var(--primary-green);
        }
        
        .pregunta label {
            display: block;
            margin-bottom: 1rem;
            font-weight: 500;
            font-size: 1.1rem;
            color: var(--light-gray);
        }
        
        .opciones {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: space-between;
        }
        
        .opcion {
            flex: 1;
            min-width: 120px;
            padding: 10px;
            border: 1px solid rgba(241, 250, 238, 0.2);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .opcion input {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .opcion:hover {
            background: rgba(42, 157, 143, 0.1);
            border-color: var(--primary-green);
        }
        
        .opcion.selected {
            background: rgba(42, 157, 143, 0.2);
            border-color: var(--primary-green);
            box-shadow: 0 0 10px rgba(42, 157, 143, 0.3);
            transform: translateY(-2px);
        }
        
        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: center;
        }
        
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        #btnEnviar {
            background: linear-gradient(45deg, var(--primary-green), var(--dark-green));
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        #btnEnviar:hover {
            background: linear-gradient(45deg, var(--dark-green), var(--primary-green));
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(42, 157, 143, 0.3);
        }
        
        .btn-cancelar {
            background: rgba(241, 250, 238, 0.1);
            color: var(--light-gray);
            border: 1px solid var(--primary-red);
        }
        
        .btn-cancelar:hover {
            background: rgba(230, 57, 70, 0.1);
            transform: translateY(-2px);
        }
        
        /* Efectos tecnológicos */
        .tech-decoration {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: -1;
        }
        
        .tech-decoration::before,
        .tech-decoration::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(42, 157, 143, 0.1) 0%, transparent 70%);
        }
        
        .tech-decoration::before {
            width: 300px;
            height: 300px;
            top: -100px;
            right: -100px;
        }
        
        .tech-decoration::after {
            width: 200px;
            height: 200px;
            bottom: -50px;
            left: -50px;
        }
        
        /* Animación de éxito */
        .success-message {
            display: none;
            background: rgba(42, 157, 143, 0.2);
            border: 1px solid var(--primary-green);
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 2rem;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            
            .container {
                padding: 1.5rem;
            }
            
            .opciones {
                flex-direction: column;
            }
            
            .opcion {
                min-width: 100%;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="tech-decoration"></div>
    
    <div class="container">
        <form>
            <h3 id="encuestaTitle">Encuesta: Cargando...</h3>
            <div id="contenedorPreguntas">
                <!-- Preguntas se insertarán aquí -->
            </div>

            <div class="button-group">
                <button type="submit" id="btnEnviar">✓ Enviar Respuestas</button>
                <button type="button" class="btn-cancelar" onclick="window.location.href='dashboard.html'">✗ Volver/Cancelar</button>
            </div>
            
            <div id="successMessage" class="success-message">
                ¡Respuestas enviadas con éxito! Redirigiendo...
            </div>
        </form>
    </div>

    <script>
        const titulo = document.getElementById("encuestaTitle");
        const formulario = document.querySelector("form");
        const divContenedor = document.getElementById("contenedorPreguntas");
        const successMessage = document.getElementById("successMessage");

        const urlParametro = new URLSearchParams(window.location.search);
        const num = urlParametro.get("numcontrol");
        const id = urlParametro.get("encuestaId");
        let numero = 1;

        async function CargarEncuesta(id) {
            try {
                const response = await fetch(`https://localhost:44341/api/Aplicaciones?idEncuensta=${id}&num=${num}`);
                if (!response.ok) {
                    alert("Ya has contestado esta encuesta antes");
                    window.location.href = `AplicarEncuesta.html`;
                    return;
                }

                const data = await response.json();
                titulo.textContent = "Encuesta: " + data.titulo;
                const preguntas = data.lstPreguntas;

                preguntas.forEach(x => {
                    const div = document.createElement("div");
                    div.classList.add("pregunta");

                    const label = document.createElement("label");
                    label.textContent = `${numero}. ${x.texto}`;
                    div.appendChild(label);

                    const opcionesDiv = document.createElement("div");
                    opcionesDiv.className = "opciones";

                    // Textos para las opciones de 1 a 5
                    const textosOpciones = [
                        "1 - Muy Insatisfecho",
                        "2 - Insatisfecho", 
                        "3 - Neutral",
                        "4 - Satisfecho",
                        "5 - Muy Satisfecho"
                    ];

                    for (let i = 1; i <= 5; i++) {
                        const opcion = document.createElement("label");
                        opcion.className = "opcion";
                        opcion.dataset.pregunta = x.id;
                        opcion.dataset.valor = i;

                        const input = document.createElement("input");
                        input.type = "radio";
                        input.name = `p${x.id}`;
                        input.value = i;
                        input.required = true;

                        opcion.innerHTML = `
                            <input type="radio" name="p${x.id}" value="${i}">
                            ${textosOpciones[i-1]}
                        `;
                        opcionesDiv.appendChild(opcion);

                        // Comportamiento visual al seleccionar
                        opcion.addEventListener("click", () => {
                            opcionesDiv.querySelectorAll(".opcion").forEach(op => 
                                op.classList.remove("selected"));
                            opcion.classList.add("selected");
                        });
                    }

                    div.appendChild(opcionesDiv);
                    divContenedor.appendChild(div);
                    numero++;
                });
            } catch (error) {
                alert("Error al cargar la encuesta: " + error.message);
            }
        }

        formulario.addEventListener("submit", async function (e) {
            e.preventDefault();

            // Validar que todas las preguntas tengan respuesta
            const preguntas = document.querySelectorAll(".pregunta");
            const radios = document.querySelectorAll("input[type='radio']:checked");
            
            if (radios.length !== preguntas.length) {
                alert("Por favor responde todas las preguntas");
                return;
            }

            const dto = {
                encuestaid: id,
                numcontrol: num,
                respuestas: []
            };

            radios.forEach(input => {
                const preguntaId = input.name.replace("p", "");
                dto.respuestas.push({
                    preguntaId: parseInt(preguntaId),
                    valor: parseInt(input.value)
                });
            });

            await enviarRespuesta(dto);
        });

        async function enviarRespuesta(dto) {
            try {
                const res = await fetch("https://localhost:44341/api/aplicaciones/aplicar", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(dto)
                });

                if (res.ok) {
                    // Mostrar mensaje de éxito
                    successMessage.style.display = "block";
                    document.querySelector(".button-group").style.display = "none";
                    
                    // Redireccionar después de 2 segundos
                    setTimeout(() => {
                        window.location.href = "dashboard.html";
                    }, 2000);
                } else {
                    const error = await res.text();
                    alert("Error al enviar respuestas: " + error);
                }
            } catch (error) {
                alert("Error de conexión: " + error.message);
            }
        }

        // Conexión SignalR
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("https://localhost:44341/hubs/encuestas")
            .withAutomaticReconnect()
            .configureLogging(signalR.LogLevel.Information)
            .build();

        connection.on("NuevaEncuestaRecibida", (mensaje) => {
            console.log("Notificación del Hub:", mensaje);
        });

        connection.start()
            .then(() => console.log("Conectado al Hub de Encuestas"))
            .catch(err => console.error("Error al conectar con el Hub:", err));

        // Cargar la encuesta al iniciar
        CargarEncuesta(id);
    </script>
</body>
</html>
